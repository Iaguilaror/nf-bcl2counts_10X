### 02-count ###
# mkfile script with dependency rules for:
#	1. To run cellranger count pipeline. For more information about Cell Ranger, see https://support.10xgenomics.com/single-cell-gene-expression/software/pipelines/latest/using/count#outputs
## For more information about 'mk' dependency control, see https://9fans.github.io/plan9port/man/man1/mk.html

## Define shell command line which will be used to run scripts.
MKSHELL="/bin/bash"

# --id, A unique run ID string.
# --transcriptome, Path to the Cell Ranger-compatible transcriptome reference.
# --fastqs, Path of the fastq_path folder generated by cellranger mkfastq.
# --sample, Sample name as specified in the sample sheet supplied to cellranger mkfastq.
# --localcores,Restricts cellranger to use specified number of cores to execute pipeline stages.
# --localmem, Restricts cellranger to use specified amount of memory (in GB) to execute pipeline stages.
# --chemistry, Assay configuration.
$OUTDIR:Q: $inputdir
	dir=$(find -L . \
	  -type d \
	  -name "*outs" )
	csv=$(find -L . \
	  -type f \
	  -wholename "$dir/*.csv")
	sample=$(tail -n+2 $csv \
	| cut -f 2 -d ",") \
	&& echo "[DEBUG] Running cellrange count for $sample"
	cellranger count \
		--id=$OUTDIR \
		--transcriptome=$TRANSCRIPTOME \
		--fastqs=$inputdir \
		--sample=$sample \
		--localcores=$THREADS \
		--localmem=$MAXMEM \
		--jobmode=local \
		--chemistry=$CHEMISTRY
